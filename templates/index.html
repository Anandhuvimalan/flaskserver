<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Email Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        .progress-container {
            width: 100%;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 0.75rem;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%);
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold text-center">Business Email Scraper</h1>
            <p class="text-center mt-2 opacity-90">Extract business emails efficiently from Google Places</p>
        </div>
    </div>
    
    <div class="container mx-auto py-8 px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Configuration Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 card">
                    <div class="flex items-center mb-4">
                        <div class="bg-emerald-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-cog text-emerald-600 text-xl"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Configuration</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">Google Places API Key</label>
                            <input type="text" id="api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter your API key">
                        </div>
                        
                        <div>
                            <label for="target-results" class="block text-sm font-medium text-gray-700 mb-1">Target Results</label>
                            <input type="number" id="target-results" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" value="100" min="1">
                            <p class="text-xs text-gray-500 mt-1">Number of businesses with emails to collect</p>
                        </div>
                        
                        <div>
                            <label for="search-query" class="block text-sm font-medium text-gray-700 mb-1">Search Query</label>
                            <input type="text" id="search-query" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" value="restaurant" placeholder="E.g., restaurant, mining, agriculture">
                            <p class="text-xs text-gray-500 mt-1">Free text search for any business type</p>
                        </div>
                        
                        <div>
                            <label for="cities-csv" class="block text-sm font-medium text-gray-700 mb-1">Cities CSV File</label>
                            <div class="flex items-center">
                                <input type="file" id="cities-csv" accept=".csv" class="hidden">
                                <button id="upload-btn" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                                    <span id="file-name">Upload CSV</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">CSV should have columns: city, lat, lng</p>
                        </div>
                        
                        <button id="start-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i>
                            Start Processing
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md p-6 card">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Progress</h2>
                    </div>
                    
                    <div id="error-container" class="hidden mb-4 p-4 rounded-md bg-red-50 border border-red-200">
                        <p id="error-message" class="text-sm text-red-800"></p>
                    </div>
                    
                    <!-- Current City Display -->
                    <div id="current-city-container" class="mb-6 p-4 rounded-md bg-blue-50 border border-blue-100 hidden">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-blue-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Currently processing:</p>
                                <p id="current-city-name" class="text-lg font-semibold text-blue-800">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                                <span id="progress-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="progress-container">
                                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-500">Status</p>
                                        <p id="status-text" class="text-sm font-medium text-gray-800">Not started</p>
                                    </div>
                                    <i class="fas fa-info-circle text-gray-400"></i>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-500">With Emails</p>
                                        <p id="with-emails-count" class="text-sm font-medium text-green-800">0</p>
                                    </div>
                                    <i class="fas fa-envelope text-green-400"></i>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-500">Without Emails</p>
                                        <p id="without-emails-count" class="text-sm font-medium text-yellow-800">0</p>
                                    </div>
                                    <i class="fas fa-envelope-open text-yellow-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <button id="stop-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed hidden flex items-center justify-center">
                                    <i class="fas fa-stop-circle mr-2"></i>
                                    Stop Process
                                </button>
                                
                                <button id="reset-btn" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 flex items-center justify-center">
                                    <i class="fas fa-redo mr-2"></i>
                                    Reset
                                </button>
                            </div>
                            
                            <div class="space-y-3">
                                <button id="download-with-emails-btn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                    <i class="fas fa-download mr-2"></i>
                                    Download With Emails
                                </button>
                                
                                <button id="download-without-emails-btn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                    <i class="fas fa-download mr-2"></i>
                                    Download Without Emails
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Card -->
                <div class="bg-white rounded-xl shadow-md p-6 mt-6 card">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-chart-pie text-purple-600 text-xl"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Processing Stats</h2>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Cities</p>
                            <p id="cities-stats" class="text-sm font-medium text-gray-800">0 / 0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Hexagons</p>
                            <p id="hexagons-stats" class="text-sm font-medium text-gray-800">0 / 0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Places</p>
                            <p id="places-stats" class="text-sm font-medium text-gray-800">0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">API Calls</p>
                            <p id="api-calls-stats" class="text-sm font-medium text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="mt-12 py-6 bg-gray-800 text-white">
        <div class="container mx-auto px-4 text-center">
            <p>Business Email Scraper &copy; 2025</p>
        </div>
    </footer>
    
    <script>
        // DOM elements
        const apiKeyInput = document.getElementById('api-key');
        const targetResultsInput = document.getElementById('target-results');
        const searchQueryInput = document.getElementById('search-query');
        const fileInput = document.getElementById('cities-csv');
        const uploadBtn = document.getElementById('upload-btn');
        const fileNameSpan = document.getElementById('file-name');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const downloadWithEmailsBtn = document.getElementById('download-with-emails-btn');
        const downloadWithoutEmailsBtn = document.getElementById('download-without-emails-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const statusText = document.getElementById('status-text');
        const withEmailsCount = document.getElementById('with-emails-count');
        const withoutEmailsCount = document.getElementById('without-emails-count');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const currentCityContainer = document.getElementById('current-city-container');
        const currentCityName = document.getElementById('current-city-name');
        const citiesStats = document.getElementById('cities-stats');
        const hexagonsStats = document.getElementById('hexagons-stats');
        const placesStats = document.getElementById('places-stats');
        const apiCallsStats = document.getElementById('api-calls-stats');
        
        // Variables
        let uploadedFileName = null;
        let isProcessing = false;
        let progressInterval = null;
        
        // Event listeners
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileNameSpan.textContent = file.name;
                
                // Upload the file
                const formData = new FormData();
                formData.append('cities_csv', file);
                
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
                    
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        showError(data.error);
                    } else {
                        uploadedFileName = data.filename;
                        hideError();
                        showSuccess('File uploaded successfully!');
                    }
                } catch (error) {
                    showError('Failed to upload file');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i><span id="file-name">' + fileNameSpan.textContent + '</span>';
                }
            }
        });
        
        startBtn.addEventListener('click', async () => {
            if (isProcessing) return;
            
            // Validate inputs
            if (!apiKeyInput.value) {
                return showError('API key is required');
            }
            
            if (!uploadedFileName) {
                return showError('Please upload a CSV file');
            }
            
            hideError();
            
            // Start the process
            try {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting...';
                
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKeyInput.value,
                        filename: uploadedFileName,
                        target_results: parseInt(targetResultsInput.value) || 100,
                        search_query: searchQueryInput.value || 'restaurant'
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Processing';
                } else {
                    // Process started successfully
                    isProcessing = true;
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Processing';
                    stopBtn.classList.remove('hidden');
                    
                    // Show the current city container
                    currentCityContainer.classList.remove('hidden');
                    currentCityContainer.classList.add('pulse-animation');
                    
                    // Start polling for progress
                    startProgressPolling();
                }
            } catch (error) {
                showError('Failed to start process');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Processing';
            }
        });
        
        stopBtn.addEventListener('click', async () => {
            if (!isProcessing) return;
            
            try {
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
                
                const response = await fetch('/stop');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                } else {
                    stopProgressPolling();
                    isProcessing = false;
                    startBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    stopBtn.innerHTML = '<i class="fas fa-stop-circle mr-2"></i>Stop Process';
                    stopBtn.disabled = false;
                    statusText.textContent = 'Stopped. Data is available for download.';
                    showSuccess('Process stopped. You can download the data collected so far.');
                    
                    // Hide the current city container
                    currentCityContainer.classList.add('hidden');
                    currentCityContainer.classList.remove('pulse-animation');
                }
            } catch (error) {
                showError('Failed to stop process');
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i class="fas fa-stop-circle mr-2"></i>Stop Process';
            }
        });
        
        resetBtn.addEventListener('click', async () => {
            try {
                resetBtn.disabled = true;
                resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting...';
                
                const response = await fetch('/reset');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                } else {
                    // Reset UI
                    isProcessing = false;
                    uploadedFileName = null;
                    fileNameSpan.textContent = 'Upload CSV';
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                    statusText.textContent = 'Not started';
                    withEmailsCount.textContent = '0';
                    withoutEmailsCount.textContent = '0';
                    citiesStats.textContent = '0 / 0';
                    hexagonsStats.textContent = '0 / 0';
                    placesStats.textContent = '0';
                    apiCallsStats.textContent = '0';
                    startBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    downloadWithEmailsBtn.disabled = true;
                    downloadWithoutEmailsBtn.disabled = true;
                    hideError();
                    
                    // Hide the current city container
                    currentCityContainer.classList.add('hidden');
                    currentCityContainer.classList.remove('pulse-animation');
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Show success message
                    showSuccess('Reset successful. You can start a new process.');
                }
            } catch (error) {
                showError('Failed to reset process');
            } finally {
                resetBtn.disabled = false;
                resetBtn.innerHTML = '<i class="fas fa-redo mr-2"></i>Reset';
            }
        });
        
        downloadWithEmailsBtn.addEventListener('click', () => {
            downloadWithEmailsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...';
            setTimeout(() => {
                window.location.href = '/download/with_emails';
                downloadWithEmailsBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Download With Emails';
            }, 500);
        });
        
        downloadWithoutEmailsBtn.addEventListener('click', () => {
            downloadWithoutEmailsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...';
            setTimeout(() => {
                window.location.href = '/download/without_emails';
                downloadWithoutEmailsBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Download Without Emails';
            }, 500);
        });
        
        // Functions
        function showError(message) {
            errorContainer.classList.remove('hidden');
            errorContainer.classList.remove('bg-green-50');
            errorContainer.classList.remove('border-green-200');
            errorContainer.classList.add('bg-red-50');
            errorContainer.classList.add('border-red-200');
            errorMessage.classList.remove('text-green-800');
            errorMessage.classList.add('text-red-800');
            errorMessage.textContent = message;
        }
        
        function hideError() {
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';
        }
        
        function showSuccess(message) {
            errorContainer.classList.remove('hidden');
            errorContainer.classList.remove('bg-red-50');
            errorContainer.classList.remove('border-red-200');
            errorContainer.classList.add('bg-green-50');
            errorContainer.classList.add('border-green-200');
            errorMessage.classList.remove('text-red-800');
            errorMessage.classList.add('text-green-800');
            errorMessage.textContent = message;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
        }
        
        function startProgressPolling() {
            // Clear any existing interval
            stopProgressPolling();
            
            // Start a new polling interval
            progressInterval = setInterval(fetchProgress, 2000);
            fetchProgress(); // Fetch immediately
        }
        
        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        async function fetchProgress() {
            try {
                const response = await fetch('/progress');
                const data = await response.json();
                
                // Update UI
                const progress = Math.round(data.progress);
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;
                statusText.textContent = data.status;
                withEmailsCount.textContent = data.businesses_with_email;
                withoutEmailsCount.textContent = data.businesses_without_email;
                
                // Update current city name if available
                if (data.current_city) {
                    currentCityName.textContent = data.current_city;
                    currentCityContainer.classList.remove('hidden');
                } else {
                    currentCityName.textContent = '-';
                    if (!isProcessing) {
                        currentCityContainer.classList.add('hidden');
                    }
                }
                
                // Update stats
                if (data.stats) {
                    citiesStats.textContent = `${data.stats.cities_processed} / ${data.stats.total_cities}`;
                    hexagonsStats.textContent = `${data.stats.hexagons_processed} / ${data.stats.total_hexagons}`;
                    placesStats.textContent = data.stats.places_processed;
                    apiCallsStats.textContent = data.stats.api_calls;
                }
                
                // Enable download buttons if we have results
                downloadWithEmailsBtn.disabled = data.businesses_with_email === 0;
                downloadWithoutEmailsBtn.disabled = data.businesses_without_email === 0;
                
                // Check if process is complete
                if (!data.running && isProcessing) {
                    isProcessing = false;
                    startBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    stopProgressPolling();
                    
                    // Hide the current city container when process is complete
                    currentCityContainer.classList.add('hidden');
                    currentCityContainer.classList.remove('pulse-animation');
                    
                    if (progress >= 100) {
                        showSuccess('Process completed successfully!');
                    }
                }
            } catch (error) {
                console.error('Error fetching progress:', error);
            }
        }
        
        // Initialize
        downloadWithEmailsBtn.disabled = true;
        downloadWithoutEmailsBtn.disabled = true;
    </script>
</body>
</html>

